<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">

    <title>Flock</title>
    <link rel="stylesheet" href="res/styles/stylesheet.css">

    <script type="text/javascript" src="lib/paper.js"></script>
    <script type="text/javascript" src="lib/jquery.js"></script>
    <script type="text/javascript" src="js/renderEngine.js"></script>
    <script type="text/javascript" src="js/world.js"></script>
    <script type="text/javascript" src="js/entity.js"></script>

    <script type="text/javascript" >

        paper.install( window );

        var resizeCanvas = function() {
            var c       = $( "#canvas" );
            var cDOM    = c.get(     0 );

            var cWidth  = c.parent().innerWidth()  - 30;
            var cHeight = c.parent().innerHeight() - 30;

            c.css( {

                width:  cWidth  + 'px', 
                height: cHeight + 'px'

            } );

            cDOM.width  =  cWidth;
            cDOM.height = cHeight;

        };

        $(document).ready( resizeCanvas );
        $(window).resize(  resizeCanvas );
        var engine;
        $(document).ready( function(){

            var world  = new World();

            var step   = function () {

                var velocity          =                     new Point();
                var separation        =                     new Point();
                var alignment         =                     new Point();
                var cohesion          =                     new Point();
                var traversible       = this.world.renderer.traversible;
                var neighbours        =                               0;
                var neighboursTooNear =                               0;
                var bodies            =               this.world.bodies;
                var                                        mag, body, d;

                for ( var i = 0; i < bodies.length ; i++ ) {

                    body =                                      bodies[ i ];
                    d    = this.position.getDistance( body.position, true );

                    // Is a Neighbour
                    if ( d <= this.__threshold && this != body ) {
                        neighbours++;

                        cohesion  = cohesion.add(  body.position );
                        alignment = alignment.add( body.velocity );

                        if ( d <= this.__personal ) {

                            neighboursTooNear++;

                            if ( d < this.__effectiveZero ) {
                                separation = separation.add( Point.random().subtract( 0.5 ).multiply( 4 * this.__maxV ) );
                            } else {
                                separation = separation.add(   this.position.subtract( body.position ).normalize( 1 / Math.sqrt( d ) ) );
                            }


                        }

                    }

                }

                if ( neighbours > 0 ) {

                    // Cohesion
                    cohesion = cohesion.divide(                                 neighbours );
                    cohesion = cohesion.subtract(                            this.position ); 
                    mag      =                                               cohesion.length;

                    cohesion = cohesion.multiply( Math.min( mag, 100 ) * this.__maxV / 100 );
                    cohesion = cohesion.subtract(                            this.velocity );

                    //Alignment
                    alignment   = alignment.divide(                                neighbours );
                    alignment   = Point.min(    alignment, alignment.normalize( this.__maxF ) );

                    if ( cohesion.length  > this.__maxF ) cohesion  = cohesion.normalize(  this.__maxF );
                    if ( alignment.length > this.__maxF ) alignment = alignment.normalize( this.__maxF );

                    cohesion    = cohesion.multiply(  this.__cohF );
                    alignment   = alignment.multiply( this.__aliF );

                }

                if ( neighboursTooNear > 0 ) {
                    separation  = separation.divide( neighboursTooNear ).multiply(         this.__sepF );
                }



                if ( !traversible.contains( this.position ) ) {

                    var rebound = new Point(                                 );
                    rebound     = traversible.center.subtract( this.position );
                    velocity    = velocity.add(                      rebound );

                }

                velocity        = velocity.add( separation );
                velocity        = velocity.add(  alignment );
                velocity        = velocity.add(   cohesion );

                if ( velocity.length > this.__maxV ) velocity = velocity.normalize( this.__maxV );

                // Debug shapes
/*                this.vArr ? this.vArr.remove() : undefined ;
                this.vArr       = new Path( this.path.position, this.path.position.add( velocity.multiply( 10 ) ) );
                this.vArr.strokeColor = 'black';

                this.threshC ? this.threshC.remove() : undefined;
                this.threshC = new Path.Circle( this.path.position, this.__threshold );
                this.threshC.strokeColor = 'blue';
                this.threshC.fillColor   = '#00A6EE';
                this.threshC.opacity     = 0.01;

                this.personalC ? this.personalC.remove() : undefined;
                this.personalC  = new Path.Circle( this.path.position, this.__personal );

                this.personalC.strokeColor = 'black';
                this.personalC.fillColor   = 'red';
                this.personalC.opacity     =  0.2;*/

                this.targetV    = velocity;

            };

            var ent;
            for ( i = 0; i < 200; i++ ) {
                ent = new Entity();

                ent.addStepFunction( step );
                world.addEntity(      ent );

            }

            engine = new RenderEngine( $( "#canvas" ).get( 0 ), world );

        } );

    </script>

</head>

<body>

    <div id="wrapper">
        <div id="name">Flock</div>

        <div id="canvas_wrapper">
            <canvas id="canvas" ></canvas>
        </div>
    </div>
    
</body>

</html>
