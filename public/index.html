<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">

    <title>Flock</title>
    <link rel="stylesheet" href="res/styles/stylesheet.css">

    <script type="text/javascript" src="lib/paper.js"></script>
    <script type="text/javascript" src="lib/jquery.js"></script>
    <script type="text/javascript" src="js/renderEngine.js"></script>
    <script type="text/javascript" src="js/world.js"></script>
    <script type="text/javascript" src="js/entity.js"></script>

    <script type="text/javascript" >

        paper.install( window );

        var resizeCanvas = function() {
            var c       = $( "#canvas" );
            var cDOM    = c.get(     0 );

            var cWidth  = c.parent().innerWidth()  - 30;
            var cHeight = c.parent().innerHeight() - 30;

            c.css( {

                width:  cWidth  + 'px', 
                height: cHeight + 'px'

            } );

            cDOM.width  =  cWidth;
            cDOM.height = cHeight;

        };

        $(document).ready( resizeCanvas );
        $(window).resize(  resizeCanvas );

        $(document).ready( function(){

            var world  = new World();

            var step   = function () {

                var velocity   = new Point( 0, 0 );

                // Find neighbours
                var neighbours =       new Array();

                var             d, body, neighbour, awayV;
                var aversion          = new Point( 0, 0 );
                var localCentre       = new Point( 0, 0 );
                var neighboursTooNear =                 0;
                var neighbours        =                 0;
                for ( var i = 0; i < this.world.bodies.length; i++ ) {

                    body       =                                     this.world.bodies[ i ];

                    d          = this.position.getDistance(          body.position, false );

                    if ( d <= this.__threshold && this != body ) {
                        neighbour = body;
                        neighbours++;

                        // Calculate Separation

                        if ( d <= this.__personal ) {

                            awayV     =       this.position.subtract( neighbour.position );
                            awayV     =           awayV.isZero() ? Point.random() : awayV ;
                            awayV     =                                  awayV.normalize();
                            awayV     = awayV.multiply( Math.min( 2, 1/d ) * this.__maxV );

                            aversion  = aversion.add(                              awayV );

                            neighboursTooNear++;
                        }

                        // Calculate centre of group

                        localCentre = localCentre.add(                neighbour.position );

                    }

                }


                if ( neighboursTooNear != 0 ) aversion    = aversion.divide(       neighboursTooNear );
                if ( neighbours        != 0 ) localCentre = localCentre.divide(           neighbours );

                var cohesion  = localCentre.subtract(                                  this.position );
                var mag       =                                                        cohesion.length;

                if (  neighbours != 0 && mag > 0 ) {
                    cohesion  = cohesion.normalize();

                    cohesion  = cohesion.multiply( this.__maxV * Math.min( mag, 10000 ) / 10000 );

                } else {
                    cohesion  = new Point( 0, 0 );
                }

                cohesion      = Point.min( cohesion, cohesion.normalize( this.__maxV ) );

                velocity      = cohesion.multiply(                         this.__cohF );
                velocity      = velocity.add(         aversion.multiply( this.__sepF ) );
                velocity      = Point.min( velocity, velocity.normalize( this.__maxV ) );

                this.targetV  =                      velocity;

            };

            var ent;
            for ( i = 0; i < 10; i++ ) {
                ent = new Entity();

                ent.addStepFunction( step );
                world.addEntity(      ent );

            }

            var engine = new RenderEngine( $( "#canvas" ).get( 0 ), world );

        } );

    </script>

</head>

<body>

    <div id="wrapper">
        <div id="name">Flock</div>

        <div id="canvas_wrapper">
            <canvas id="canvas" ></canvas>
        </div>
    </div>
    
</body>

</html>
